<html>
<head>
    <title>
        Sarvika Tambola Game
    </title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
            integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Online free Tambola Game"/>
    <meta property="og:description" content="Online free Tambola Game"/>
    <meta property="article:published_time" content="2017-09-22T22:16:24+00:00"/>
    <meta property="article:modified_time" content="2017-09-22T22:29:25+00:00"/>
    <meta property="og:site_name" content="All about Web and Cloud"/>
    <meta property="og:locale" content="en_US"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <script>
        function openForm() {
            document.getElementById("myForm").style.display = "block";
        }

        function closeForm() {
            document.getElementById("myForm").style.display = "none";
        }
    </script>

</head>
<body>

<div class="container">
    <div class="bigNumberDisplay">
        <span class="mirage" id="mirageElement">X</span>
        <div class="bingoNumberDesc" id="bingoWords">0
        </div>
        <div style="font-size: 20px;">Current No.</div>
    </div>
    <!-- Chatbox button -->
    <div style="position: absolute; right: 1300px; top: 30px;">
        <img class="open-button" onclick="openForm()" src="{{ url_for('static', filename='image/chat-button.png') }}"> 

        <div class="chat-popup" id="myForm">
            <form class="form-container">
                <h1>Chat</h1>

                <label><b>Message</b></label>
                <textarea placeholder="Type message.." name="msg" required id="chatarea">
                   
                </textarea>

                <button type="submit" id="sendbutton" class="btn">Send</button>
                <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
            </form>
        </div>

    </div>
    <!-- Chatbox button close -->
    <!-- tambola logo -->
        <img src="/static/image/logo-small.png" width="400px" style="position: absolute; left: 136px; top: 178px;">
    <!-- tambola logo end -->
    <div id="button-container" style="position: absolute; left: 218px; top: 438px;" >
    </div>
    <br/>

    <div class="row">
        <div class="previousNo">
            <div id="prevNum" style="font-size: 8em;">0</div>
            <div style="padding-top: 10px; font-size: 20px;">Previous No.</div>
        </div>
        <div class="col-md-10">
            <table>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    
                </tr>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    
                </tr>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    
                </tr>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    
                </tr>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    
                </tr>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    
                </tr>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    
                </tr>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    
                </tr>
                <tr style="text-align: center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>

            <form>

                <span style="background-image: url(/static/image/ticket_bg.jpg); width: 600px; height: 170px; background-size: cover; position: absolute; top: 400px; left: 650;"></span>
                <div style="position: absolute;top: 406px;color: white;left: 678px;">
                <div >YOUR TICKET</div>
                <div style="border-bottom-style: dotted;width: 550;padding-top: 8px;"></div>
                </div>
                <table id="tambola_tickets" style="position: absolute; top: 455px; left: 668px; min-width: 20px;">

                </table>
            </form>
        </div>
    </div>
    <br/>
</div>

<script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
<script type="text/javascript">
    var bingoNumberWords = [""];
    (function ($) {
        $.fn.extend({
            numAnim: function (options) {
                if (!this.length)
                    return false;

                this.defaults = {
                    endAt: 2560,
                    numClass: 'autogen-num',
                    duration: 2,   // seconds
                    interval: 90  // ms
                };
                var settings = $.extend({}, this.defaults, options);

                var $num = $('<span/>', {
                    'class': settings.numClass
                });

                return this.each(function () {
                    var $this = $(this);

                    // Wrap each number in a tag.
                    var frag = document.createDocumentFragment(),
                        numLen = settings.endAt.toString().length;
                    for (x = 0; x < numLen; x++) {
                        var rand_num = Math.floor(Math.random() * 10);
                        frag.appendChild($num.clone().text(rand_num)[0])
                    }
                    $this.empty().append(frag);

                    var get_next_num = function (num) {
                        ++num;
                        if (num > 9) return 0;
                        return num;
                    };

                    // Iterate each number.
                    $this.find('.' + settings.numClass).each(function () {
                        var $num = $(this),
                            num = parseInt($num.text());

                        var interval = setInterval(function () {
                            num = get_next_num(num);
                            $num.text(num);
                        }, settings.interval);

                        setTimeout(function () {
                            clearInterval(interval);
                        }, settings.duration * 1000 - settings.interval);
                    });

                    setTimeout(function () {
                        $this.text(settings.endAt.toString());
                        $("#mirageElement").css("display", "none");
                        $('#numCounter').css("display", "");

                    }, settings.duration * 1000);
                });
            }
        });
    })(jQuery);

    $(function () {
        var bingo = {
            selectedNumbers: [],
            generateRandom: function () {
                var min = 1;
                var max = 90;
                var random = Math.floor(Math.random() * (max - min + 1)) + min;
                return random;
            },
            generateNextRandom: function () {
                if (bingo.selectedNumbers.length > 89) {
                    alert("All numbers Exhausted");
                    return 0;
                }
                var random = bingo.generateRandom();
                while ($.inArray(random, bingo.selectedNumbers) > -1) {
                    random = bingo.generateRandom();
                }
                bingo.selectedNumbers.push(random);
                return random;
            }
        };
        $("#mirageElement").css("display", "none");
        $('td').each(function () {
            var concatClass = this.cellIndex + "" + this.parentNode.rowIndex;
            var numberString = parseInt(concatClass, 10).toString();
            $(this).addClass("cell" + numberString).text(numberString);
        });
        var random = 0;
        var animDuration = 2;
        document.generateNumber = function () {
            $("#bingoWords").css("display", "none");
            $('#prevNum').text($('#numCounter').text());
            random = bingo.generateNextRandom().toString();
            $("#numCounter").css("display", "none");
            $("#mirageElement").css("display", "");
            $('#numCounter').text(random);
            //$('td.cell' + random).addClass('selected');
            $("#mirageElement").numAnim({
                endAt: 90,
                duration: animDuration
            });
            setTimeout(function () {
                if (bingoNumberWords[random - 1]) {
                    $("#bingoWords").text(bingoNumberWords[random - 1]);
                } else {
                    $("#bingoWords").text("");
                }
                $('td.cell' + random).addClass('selected');
                $("#numCounter").animate({zoom: '150%'}, "slow");
                $("#numCounter").animate({zoom: '100%'}, "slow");

                window._socket.emit('generate_number', {
                    id: window._game_id,
                    cookie: getCookie('game_cookie'),
                    number: random,
                })

            }, animDuration * 1000);
            $("#bingoWords").css("display", "block")
        }

        $(document).ready(function () {
            var form = $('#display_no');
            var numCounter = $('#numCounter')

            $.ajax({
                url: 'insert.php',
                type: 'post',
                data: $("#display_no", "#numCounter").serialize(),
            });

        });

        window.onbeforeunload = function (e) {
            e = e || window.event;
            var returnString = 'Are you sure?';
            if (e) {
                e.returnValue = returnString;
            }
            return returnString;
        };
    });
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
        integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
<script type="text/javascript">

    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function createBoard(board) {
        if (window._initialized) {
            return
        }

        if (board.isAdmin) {
            $('#button-container').append(`<input onclick="javascript:document.generateNumber();" type="button" value="Generate Number" style="border-radius: 20px; width: 250px; height: 50px; font-size: 24px; background-image: linear-gradient(#c59c0c, #fcf1cd, #c59c0c); border: none;"/>`)
        }

        var html = '';

        for (var i = 0; i < board.ticket.length; i++) {
            var tkt = board.ticket[i];

            html += `<tr id="row_${i}>`;
            for (var j = 0; j < tkt.length; j++) {
                html += `<td style="background-image: url('static/image/ticket_bg.jpg') background-color: none;" id="number_${tkt[j]}">${tkt[j] == 0 ? ' ' : tkt[j]}</td>`
            }
            html += `</tr>`
        }

        $('#tambola_tickets').append(html)
        window._initialized = true
    }

    function updateNumber(data) {
        var curNum = $('#bingoWords')

        $('#prevNum').text(curNum.text())
        curNum.text(data.num)

        $(`#number_${data.num}`).css('color', '#331e5e');
    }

    $(document).ready(function () {
        var url = window.location.href
        var idx = url.lastIndexOf('/') + 1

        var game_id = url.substring(idx)

        window._socket = io('http://127.0.0.1:5000');
        window._socket.on('connect', function () {
            window._game_id = game_id
            window._socket.emit('get_game_state', {
                id: game_id,
                cookie: getCookie('game_cookie')
            })
        })


        window._socket.on('message', function (data) {
            console.log("Got websocket data", data)

            switch (data.type) {
                case "game":
                    createBoard(data.data);
                    break;
                case "number":
                    updateNumber(data.data);
                    break;
            }
        })
    });





//     // chatbox
//     <script type="text/javascript">
// $(document).ready(function() {

//     var socket = io.connect('http://127.0.0.1:5000');

//     socket.on('connect', function() {
//         socket.send('User has connected!');
//     });

//     socket.on('message', function(msg) {
//         $("#messages").append('<li>'+msg+'</li>');
//         console.log('Received message');
//     });

//     $('#sendbutton').on('click', function() {
//         socket.send($('#myMessage').val());
//         $('#myMessage').val('');
//     });

// });
// // chatbox end
</script>
</script>


</body>
</html>
